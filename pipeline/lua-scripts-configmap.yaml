# ============================================================================
# ConfigMap: Lua 스크립트
# ============================================================================
# JSON 파싱은 네이티브 ClusterParser가 담당 (cluster-parser-json.yaml)
# Lua는 메타데이터 가공만 담당:
#   1. contextMap 필드 평탄화 (traceId, spanId → 최상위)
#   2. namespace 추출 (contextMap 또는 source_file 경로)
# ============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-lua-scripts
  namespace: logging
data:
  enrich_metadata.lua: |
    function enrich_metadata(tag, timestamp, record)
      -- [1단계] contextMap 평탄화
      -- JSON 파서가 contextMap을 테이블로 파싱한 경우 개별 필드로 추출
      local ctx = record["contextMap"]
      if ctx and type(ctx) == "table" then
        for k, v in pairs(ctx) do
          record[k] = v
        end
        record["contextMap"] = nil
      end

      -- [2단계] namespace 추출
      -- 우선순위: contextMap.namespace(위에서 평탄화) > source_file 경로
      if not record["namespace"] then
        local source = record["source_file"]
        if source then
          local ns = string.match(source, "/var/log/([^/]+)/")
          record["namespace"] = ns or "unknown"
        else
          record["namespace"] = "unknown"
        end
      end

      return 1, timestamp, record
    end
